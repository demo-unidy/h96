---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Newsletter verwalten - Hannover 96" activePage="newsletter" pageStyles={['preference-center']}>
    <main class="main-content">
        <u-config
            base-url="https://hannover96.staging.unidy.de"
            api-key="b9671a31543ed2db7679511882ece8fcbd020f8ee996a3274026302a1834c82e"
            locale="de">
        </u-config>

        <u-newsletter-root class="pref-root">
            <!-- Hero Section -->
            <section class="pref-hero">
                <div class="container">
                    <h1 class="pref-hero__title">Deine Newsletter-Einstellungen</h1>
                    <p class="pref-hero__subtitle">
                        Verwalte hier deine Hannover 96 Newsletter und passe an, welche Inhalte du erhalten möchtest.
                    </p>
                </div>
            </section>

            <!-- Email Bar -->
            <section class="pref-email-section">
                <div class="container">
                    <div class="pref-email-bar">
                        <!-- Logged In State -->
                        <u-conditional-render when="newsletter.loggedIn">
                            <div class="pref-email-bar__badge">
                                <div class="pref-email-bar__badge-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                </div>
                                <div class="pref-email-bar__info">
                                    <span class="pref-email-bar__label">Eingeloggt als</span>
                                    <u-email-field class-name="pref-email-bar__email" disabled></u-email-field>
                                </div>
                                <u-newsletter-logout-button class-name="pref-email-bar__logout">
                                    Andere E-Mail
                                </u-newsletter-logout-button>
                            </div>
                        </u-conditional-render>

                        <!-- Not Logged In State -->
                        <u-conditional-render when="newsletter.loggedIn" is="false">
                            <div class="pref-email-bar__login">
                                <div class="pref-email-bar__input-wrapper">
                                    <u-email-field placeholder="Deine E-Mail-Adresse" class-name="pref-email-input" for="login"></u-email-field>
                                    <u-error-message for="email" class-name="pref-error-message"></u-error-message>
                                </div>
                                <u-submit-button for="login" text="Anmelden" class-name="pref-submit-btn"></u-submit-button>
                            </div>
                            <div class="pref-email-bar__alt">
                                <span>oder</span>
                                <a href="/newsletter-subscription" class="pref-email-bar__link">
                                    Newsletter abonnieren
                                </a>
                            </div>
                        </u-conditional-render>
                    </div>
                </div>
            </section>

            <u-error-message for="general" class-name="pref-error-general"></u-error-message>

            <!-- Preference Sections (Only when logged in) -->
            <u-conditional-render when="newsletter.loggedIn">
                <div class="pref-sections">
                    <div class="container">
                        <!-- Newsletter with Preferences -->
                        <section class="pref-section">
                            <div class="pref-section__header">
                                <div class="pref-section__title-row">
                                    <span class="pref-section__badge">H96</span>
                                    <h2 class="pref-section__title">Hannover 96 Newsletter</h2>
                                </div>
                                <div class="pref-section__actions">
                                    <u-conditional-render when="newsletter.subscribed" is="ns_with_prefs">
                                        <button type="button" class="pref-section__unsubscribe" data-open-modal="modal-ns-with-prefs">
                                            Abbestellen
                                        </button>
                                    </u-conditional-render>
                                    <u-conditional-render when="newsletter.subscribed" is="ns_with_prefs" not>
                                        <u-newsletter-toggle-subscription-button internal-name="ns_with_prefs" class-name="pref-section__subscribe">
                                        </u-newsletter-toggle-subscription-button>
                                    </u-conditional-render>
                                </div>
                            </div>

                            <p class="pref-section__description">
                                Alle News rund um Hannover 96: Spielberichte, Transfers, Interviews und mehr.
                                Wöchentlich in deinem Postfach.
                            </p>

                            <!-- DOI Banner -->
                            <u-conditional-render when="newsletter.subscribed" is="ns_with_prefs">
                                <u-conditional-render when="newsletter.confirmed" is="ns_with_prefs" not>
                                    <div class="pref-doi-banner">
                                        <span class="pref-doi-banner__icon">&#x2709;</span>
                                        <span class="pref-doi-banner__text">Bitte bestätige deine E-Mail-Adresse</span>
                                        <u-newsletter-resend-doi-button internal-name="ns_with_prefs" class-name="pref-doi-banner__btn">
                                            Erneut senden
                                        </u-newsletter-resend-doi-button>
                                    </div>
                                </u-conditional-render>
                            </u-conditional-render>

                            <!-- Preferences (only when subscribed) -->
                            <u-conditional-render when="newsletter.subscribed" is="ns_with_prefs">
                                <details class="pref-category" open>
                                    <summary class="pref-category__toggle">
                                        <span class="pref-category__title">Themenpräferenzen</span>
                                        <span class="pref-category__icon">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </span>
                                    </summary>
                                    <div class="pref-category__content">
                                        <div class="pref-item">
                                            <div class="pref-item__info">
                                                <span class="pref-item__name">Vereinsnews</span>
                                                <p class="pref-item__description">Neuigkeiten rund um den Verein</p>
                                            </div>
                                            <div class="pref-item__toggle">
                                                <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="club_news_pref" class-name="pref-toggle">
                                                </u-newsletter-preference-checkbox>
                                            </div>
                                        </div>
                                        <div class="pref-item">
                                            <div class="pref-item__info">
                                                <span class="pref-item__name">Spieler-News</span>
                                                <p class="pref-item__description">Infos zu Spielern und Transfers</p>
                                            </div>
                                            <div class="pref-item__toggle">
                                                <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="player_news_pref" class-name="pref-toggle">
                                                </u-newsletter-preference-checkbox>
                                            </div>
                                        </div>
                                        <div class="pref-item">
                                            <div class="pref-item__info">
                                                <span class="pref-item__name">Sonstiges</span>
                                                <p class="pref-item__description">Weitere interessante Themen</p>
                                            </div>
                                            <div class="pref-item__toggle">
                                                <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="random_news_pref" class-name="pref-toggle">
                                                </u-newsletter-preference-checkbox>
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </u-conditional-render>
                        </section>

                        <!-- Newsletter without Preferences -->
                        <section class="pref-section pref-section--compact">
                            <div class="pref-section__header">
                                <div class="pref-section__title-row">
                                    <span class="pref-section__badge pref-section__badge--spieltag">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                            <polyline points="22,6 12,13 2,6"/>
                                        </svg>
                                    </span>
                                    <h2 class="pref-section__title">Allgemeiner Newsletter</h2>
                                </div>
                                <div class="pref-section__actions">
                                    <u-conditional-render when="newsletter.subscribed" is="ns_without_prefs">
                                        <button type="button" class="pref-section__unsubscribe" data-open-modal="modal-ns-without-prefs">
                                            Abbestellen
                                        </button>
                                    </u-conditional-render>
                                    <u-conditional-render when="newsletter.subscribed" is="ns_without_prefs" not>
                                        <u-newsletter-toggle-subscription-button internal-name="ns_without_prefs" class-name="pref-section__subscribe">
                                        </u-newsletter-toggle-subscription-button>
                                    </u-conditional-render>
                                </div>
                            </div>

                            <p class="pref-section__description">
                                Kompakte Updates ohne Themenwahl - alle wichtigen Infos auf einen Blick.
                            </p>

                            <!-- DOI Banner -->
                            <u-conditional-render when="newsletter.subscribed" is="ns_without_prefs">
                                <u-conditional-render when="newsletter.confirmed" is="ns_without_prefs" not>
                                    <div class="pref-doi-banner">
                                        <span class="pref-doi-banner__icon">&#x2709;</span>
                                        <span class="pref-doi-banner__text">Bitte bestätige deine E-Mail-Adresse</span>
                                        <u-newsletter-resend-doi-button internal-name="ns_without_prefs" class-name="pref-doi-banner__btn">
                                            Erneut senden
                                        </u-newsletter-resend-doi-button>
                                    </div>
                                </u-conditional-render>
                            </u-conditional-render>
                        </section>

                        <!-- Footer Info -->
                        <div class="pref-footer-section">
                            <p class="pref-footer-info">
                                Du kannst deine Einstellungen jederzeit ändern oder Newsletter abbestellen.
                            </p>
                            <div class="pref-footer-legal">
                                <a href="#">Datenschutz</a>
                                <span>&bull;</span>
                                <a href="#">Impressum</a>
                            </div>
                        </div>
                    </div>
                </div>
            </u-conditional-render>

            <!-- Not Logged In - Prompt -->
            <u-conditional-render when="newsletter.loggedIn" is="false">
                <section class="pref-login-prompt">
                    <div class="container">
                        <div class="pref-login-prompt__card">
                            <div class="pref-login-prompt__icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </div>
                            <h2 class="pref-login-prompt__title">Newsletter verwalten</h2>
                            <p class="pref-login-prompt__text">
                                Gib deine E-Mail-Adresse oben ein, um deine Newsletter-Einstellungen zu verwalten.
                            </p>
                        </div>
                    </div>
                </section>
            </u-conditional-render>
        </u-newsletter-root>
    </main>

    <!-- Modals -->
    <dialog id="modal-ns-with-prefs" class="pref-modal">
        <div class="pref-modal__content">
            <h3 class="pref-modal__title">Newsletter abbestellen?</h3>
            <div class="pref-modal__text">
                <p>Möchtest du den <strong>Hannover 96 Newsletter</strong> wirklich abbestellen?</p>
                <p>Du wirst keine Updates mehr zu Spielberichten, Transfers und Interviews erhalten.</p>
            </div>
            <div class="pref-modal__actions">
                <button type="button" class="pref-modal__cancel" data-close-modal>Abbrechen</button>
                <u-newsletter-toggle-subscription-button internal-name="ns_with_prefs" class-name="pref-modal__confirm">
                </u-newsletter-toggle-subscription-button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-ns-without-prefs" class="pref-modal">
        <div class="pref-modal__content">
            <h3 class="pref-modal__title">Newsletter abbestellen?</h3>
            <div class="pref-modal__text">
                <p>Möchtest du den <strong>Allgemeinen Newsletter</strong> wirklich abbestellen?</p>
                <p>Du wirst keine kompakten Updates mehr erhalten.</p>
            </div>
            <div class="pref-modal__actions">
                <button type="button" class="pref-modal__cancel" data-close-modal>Abbrechen</button>
                <u-newsletter-toggle-subscription-button internal-name="ns_without_prefs" class-name="pref-modal__confirm">
                </u-newsletter-toggle-subscription-button>
            </div>
        </div>
    </dialog>

    <script is:inline>
        document.addEventListener('DOMContentLoaded', () => {
            // Open modal
            document.querySelectorAll('[data-open-modal]').forEach(button => {
                button.addEventListener('click', () => {
                    const modalId = button.getAttribute('data-open-modal');
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.showModal();
                    }
                });
            });

            // Close modal
            document.querySelectorAll('[data-close-modal]').forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('dialog');
                    if (modal) {
                        modal.close();
                    }
                });
            });

            // Close on backdrop click
            document.querySelectorAll('.pref-modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.close();
                    }
                });
            });

            // Close modal after unsubscribe action
            document.querySelectorAll('.pref-modal u-newsletter-toggle-subscription-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('dialog');
                    if (modal) {
                        setTimeout(() => modal.close(), 100);
                    }
                });
            });
        });
    </script>
</Layout>
