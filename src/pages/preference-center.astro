---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Einstellungen | Hannover 96" pageStyles={['preference-center']} footerVariant="minimal">
    <!-- Hero Section -->
    <section class="pref-hero">
        <div class="container">
            <h1 class="pref-hero__title">Newsletter Einstellungen</h1>
            <p class="pref-hero__subtitle">Verwalte deine Newsletter-Abonnements und Pr√§ferenzen</p>
        </div>
    </section>

    <!-- Newsletter Root -->
    <u-newsletter-root>
        <u-config
            base-url="https://hannover96.staging.unidy.de"
            api-key="b9671a31543ed2db7679511882ece8fcbd020f8ee996a3274026302a1834c82e"
            locale="de"
        ></u-config>

        <!-- Email Section -->
        <section class="pref-email-section">
            <div class="container">
                <div class="pref-email-bar">
                    <!-- Not Logged In State -->
                    <u-signin-root>
                        <div class="pref-email-bar__login">
                            <div class="pref-email-bar__input-wrapper">
                                <u-email-field class-name="pref-email-input" name="email" placeholder="Deine E-Mail-Adresse"></u-email-field>
                                <u-error-message name="email" class-name="pref-error-message"></u-error-message>
                            </div>
                            <u-submit-button class-name="pref-submit-btn">Einstellungen laden</u-submit-button>
                        </div>
                        <p class="pref-email-bar__alt">
                            Hast du ein Konto?
                            <button type="button" class="pref-email-bar__link" onclick="openLoginModal()">Hier anmelden</button>
                        </p>
                    </u-signin-root>

                    <!-- Logged In State -->
                    <u-signed-in>
                        <div class="pref-email-bar__badge">
                            <div class="pref-email-bar__badge-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="pref-email-bar__info">
                                <span class="pref-email-bar__label">Einstellungen f√ºr</span>
                                <u-field name="email" class-name="pref-email-bar__email" readonly></u-field>
                            </div>
                            <u-newsletter-logout-button class-name="pref-email-bar__logout">Andere E-Mail</u-newsletter-logout-button>
                        </div>
                    </u-signed-in>
                </div>
                <u-error-message class-name="pref-error-general"></u-error-message>
            </div>
        </section>

        <!-- Preference Sections -->
        <main class="pref-sections">
            <div class="container">
                <!-- Hannover 96 News Section -->
                <section class="pref-section">
                    <div class="pref-section__header">
                        <div class="pref-section__title-row">
                            <span class="pref-section__badge">H96</span>
                            <h2 class="pref-section__title">Hannover 96 News</h2>
                        </div>
                        <div class="pref-section__actions">
                            <u-conditional-render if="newsletter.h96-main.subscribed == false">
                                <u-newsletter-toggle-subscription-button newsletter-id="h96-main" class-name="pref-section__subscribe">Abonnieren</u-newsletter-toggle-subscription-button>
                            </u-conditional-render>
                            <u-conditional-render if="newsletter.h96-main.subscribed == true">
                                <button type="button" class="pref-section__unsubscribe" onclick="showUnsubscribeModal('h96-main', 'Hannover 96 News')">Abbestellen</button>
                            </u-conditional-render>
                        </div>
                    </div>
                    <p class="pref-section__description">W√∂chentliche Updates zu Transfers, Spielberichten, Interviews und Vereinsnews.</p>

                    <!-- DOI Banner -->
                    <u-conditional-render if="newsletter.h96-main.doiPending">
                        <div class="pref-doi-banner">
                            <span class="pref-doi-banner__icon">üìß</span>
                            <span class="pref-doi-banner__text">Bitte best√§tige deine E-Mail-Adresse</span>
                            <u-newsletter-resend-doi-button newsletter-id="h96-main" class-name="pref-doi-banner__btn">Erneut senden</u-newsletter-resend-doi-button>
                        </div>
                    </u-conditional-render>

                    <!-- Preferences -->
                    <u-conditional-render if="newsletter.h96-main.subscribed == true">
                        <details class="pref-category" open>
                            <summary class="pref-category__toggle">
                                <span class="pref-category__title">Profis</span>
                                <svg class="pref-category__icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </summary>
                            <div class="pref-category__content">
                                <div class="pref-item">
                                    <div class="pref-item__info">
                                        <span class="pref-item__name">News & Spielberichte</span>
                                        <p class="pref-item__description">Aktuelle Nachrichten zur ersten Mannschaft</p>
                                    </div>
                                    <div class="pref-item__toggle">
                                        <u-newsletter-preference-checkbox newsletter-id="h96-main" preference-id="news" class-name="pref-toggle"></u-newsletter-preference-checkbox>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <details class="pref-category">
                            <summary class="pref-category__toggle">
                                <span class="pref-category__title">Fanshop</span>
                                <svg class="pref-category__icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </summary>
                            <div class="pref-category__content">
                                <div class="pref-item">
                                    <div class="pref-item__info">
                                        <span class="pref-item__name">Neue Produkte</span>
                                        <p class="pref-item__description">Infos zu neuen Fanartikeln und Trikots</p>
                                    </div>
                                    <div class="pref-item__toggle">
                                        <u-newsletter-preference-checkbox newsletter-id="h96-main" preference-id="shop" class-name="pref-toggle"></u-newsletter-preference-checkbox>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <details class="pref-category">
                            <summary class="pref-category__toggle">
                                <span class="pref-category__title">Ticketshop</span>
                                <svg class="pref-category__icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </summary>
                            <div class="pref-category__content">
                                <div class="pref-item">
                                    <div class="pref-item__info">
                                        <span class="pref-item__name">Ticket-Angebote</span>
                                        <p class="pref-item__description">Infos zu Ticketverk√§ufen und Sonderaktionen</p>
                                    </div>
                                    <div class="pref-item__toggle">
                                        <u-newsletter-preference-checkbox newsletter-id="h96-main" preference-id="tickets" class-name="pref-toggle"></u-newsletter-preference-checkbox>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </u-conditional-render>
                </section>

                <!-- Spieltag Newsletter Section -->
                <section class="pref-section">
                    <div class="pref-section__header">
                        <div class="pref-section__title-row">
                            <span class="pref-section__badge pref-section__badge--spieltag">ST</span>
                            <h2 class="pref-section__title">Spieltag Newsletter</h2>
                        </div>
                        <div class="pref-section__actions">
                            <u-conditional-render if="newsletter.spieltag.subscribed == false">
                                <u-newsletter-toggle-subscription-button newsletter-id="spieltag" class-name="pref-section__subscribe">Abonnieren</u-newsletter-toggle-subscription-button>
                            </u-conditional-render>
                            <u-conditional-render if="newsletter.spieltag.subscribed == true">
                                <button type="button" class="pref-section__unsubscribe" onclick="showUnsubscribeModal('spieltag', 'Spieltag Newsletter')">Abbestellen</button>
                            </u-conditional-render>
                        </div>
                    </div>
                    <p class="pref-section__description">Aufstellung, Live-Ticker Erinnerung und Ergebnisse vor jedem Spieltag.</p>
                </section>

                <!-- Fanshop Newsletter Section -->
                <section class="pref-section">
                    <div class="pref-section__header">
                        <div class="pref-section__title-row">
                            <span class="pref-section__badge pref-section__badge--fanshop">FS</span>
                            <h2 class="pref-section__title">Fanshop Newsletter</h2>
                        </div>
                        <div class="pref-section__actions">
                            <u-conditional-render if="newsletter.fanshop.subscribed == false">
                                <u-newsletter-toggle-subscription-button newsletter-id="fanshop" class-name="pref-section__subscribe">Abonnieren</u-newsletter-toggle-subscription-button>
                            </u-conditional-render>
                            <u-conditional-render if="newsletter.fanshop.subscribed == true">
                                <button type="button" class="pref-section__unsubscribe" onclick="showUnsubscribeModal('fanshop', 'Fanshop Newsletter')">Abbestellen</button>
                            </u-conditional-render>
                        </div>
                    </div>
                    <p class="pref-section__description">Neue Produkte, exklusive Angebote und Rabattaktionen im Fanshop.</p>
                </section>

                <!-- Footer Section -->
                <div class="pref-footer-section">
                    <p class="pref-footer-info">Du kannst deine Einstellungen jederzeit √§ndern oder dich komplett abmelden.</p>
                    <div class="pref-footer-legal">
                        <a href="#">Datenschutzerkl√§rung</a>
                        <span>|</span>
                        <a href="#">Impressum</a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Unsubscribe Confirmation Modal -->
        <dialog id="unsubscribeModal" class="pref-modal">
            <div class="pref-modal__content">
                <h3 class="pref-modal__title">Newsletter abbestellen?</h3>
                <p class="pref-modal__text" id="unsubscribeModalText">M√∂chtest du den Newsletter wirklich abbestellen?</p>
                <div class="pref-modal__actions">
                    <button type="button" class="pref-modal__cancel" onclick="closeUnsubscribeModal()">Abbrechen</button>
                    <u-newsletter-toggle-subscription-button id="unsubscribeModalBtn" class-name="pref-modal__confirm">Abbestellen</u-newsletter-toggle-subscription-button>
                </div>
            </div>
        </dialog>
    </u-newsletter-root>
</Layout>

<script is:inline>
    const unsubscribeModal = document.getElementById('unsubscribeModal');
    const unsubscribeModalText = document.getElementById('unsubscribeModalText');
    const unsubscribeModalBtn = document.getElementById('unsubscribeModalBtn');

    function showUnsubscribeModal(newsletterId, newsletterName) {
        unsubscribeModalText.textContent = `M√∂chtest du "${newsletterName}" wirklich abbestellen?`;
        unsubscribeModalBtn.setAttribute('newsletter-id', newsletterId);
        unsubscribeModal.showModal();
    }

    function closeUnsubscribeModal() {
        unsubscribeModal.close();
    }

    // Close modal when clicking backdrop
    unsubscribeModal?.addEventListener('click', (e) => {
        if (e.target === unsubscribeModal) {
            closeUnsubscribeModal();
        }
    });

    // Make functions globally available
    window.showUnsubscribeModal = showUnsubscribeModal;
    window.closeUnsubscribeModal = closeUnsubscribeModal;
</script>
