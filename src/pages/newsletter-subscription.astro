---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Newsletter abonnieren - Hannover 96" activePage="newsletter" pageStyles={['newsletter-subscription']}>
    <main class="main-content">
        <u-config
            base-url="https://hannover96.staging.unidy.de"
            api-key="b9671a31543ed2db7679511882ece8fcbd020f8ee996a3274026302a1834c82e"
            locale="de">
        </u-config>

        <!-- Hero Section -->
        <section class="newsletter-hero">
            <div class="container">
                <h1 class="newsletter-hero__title">Die Hannover 96 Newsletter direkt ins Postfach!</h1>
                <p class="newsletter-hero__subtitle">
                    Abonniere unsere kostenlosen Newsletter und verpasse keine News,
                    Spielberichte und exklusive Aktionen rund um Hannover 96.
                </p>
            </div>
        </section>

        <u-newsletter-root>
            <!-- Action Bar (Sticky) -->
            <section class="newsletter-action-bar">
                <div class="container">
                    <!-- Logged In State -->
                    <u-conditional-render when="newsletter.loggedIn">
                        <div class="action-bar-card action-bar-card--success">
                            <div class="action-bar-content">
                                <div class="action-bar-user">
                                    <span class="action-bar-icon action-bar-icon--success">&#x2713;</span>
                                    <div class="action-bar-user-info">
                                        <span class="action-bar-label">Eingeloggt als</span>
                                        <u-email-field class-name="action-bar-email" disabled></u-email-field>
                                    </div>
                                </div>
                                <div class="action-bar-actions">
                                    <u-newsletter-logout-button class-name="btn-action-secondary">
                                        Andere E-Mail verwenden
                                    </u-newsletter-logout-button>
                                </div>
                            </div>
                            <p class="action-bar-hint">
                                Verwalte unten deine Newsletter-Abonnements. Änderungen werden automatisch gespeichert.
                            </p>
                        </div>
                    </u-conditional-render>

                    <!-- Not Logged In State -->
                    <u-conditional-render when="newsletter.loggedIn" not>
                        <div class="action-bar-card">
                            <div class="action-bar-content">
                                <div class="action-bar-input-group">
                                    <div class="action-bar-input-wrapper">
                                        <u-email-field placeholder="E-Mail-Adresse eingeben" class-name="action-bar-input"></u-email-field>
                                    </div>
                                    <u-submit-button class-name="btn-action-primary">
                                        Jetzt abonnieren
                                    </u-submit-button>
                                </div>
                                <u-error-message for="email" class-name="action-bar-error"></u-error-message>
                                <u-error-message for="general" class-name="action-bar-error"></u-error-message>
                            </div>

                            <div class="action-bar-footer">
                                <p class="action-bar-legal">
                                    Mit dem Absenden stimmst du unserer <a href="#">Datenschutzerklärung</a> zu.
                                </p>
                                <u-conditional-render when="newsletter.hasEmail">
                                    <u-submit-button for="login" class-name="action-bar-login-link">
                                        Bereits abonniert? Klicke hier zur Verwaltung &rarr;
                                    </u-submit-button>
                                </u-conditional-render>
                            </div>
                        </div>
                    </u-conditional-render>
                </div>
            </section>

            <!-- Newsletter Selection -->
            <section class="newsletter-selection">
                <div class="container">
                    <!-- Section Header -->
                    <u-conditional-render when="newsletter.loggedIn">
                        <h2 class="section-title">Deine Abonnements</h2>
                    </u-conditional-render>
                    <u-conditional-render when="newsletter.loggedIn" not>
                        <h2 class="section-title">Wähle deine Newsletter</h2>
                        <p class="section-subtitle">Aktiviere die Newsletter, die dich interessieren. Du kannst deine Auswahl jederzeit ändern.</p>
                    </u-conditional-render>

                    <!-- Main Newsletter with Preferences (Featured - Full Width) -->
                    <div class="newsletter-featured">
                        <div class="newsletter-card">
                            <div class="newsletter-card__header">
                                <div class="newsletter-card__icon-badge">H96</div>
                                <div class="newsletter-card__info">
                                    <h3 class="newsletter-card__title">Hannover 96 Newsletter</h3>
                                    <p class="newsletter-card__description">Alle News rund um Hannover 96: Spielberichte, Transfers und Interviews</p>
                                    <u-conditional-render when="newsletter.loggedIn" not>
                                        <span class="newsletter-card__frequency">Wöchentlich</span>
                                    </u-conditional-render>
                                </div>

                                <u-conditional-render when="newsletter.loggedIn" not>
                                    <u-newsletter-checkbox internal-name="ns_with_prefs" checked="true" class-name="newsletter-toggle"></u-newsletter-checkbox>
                                </u-conditional-render>

                                <u-conditional-render when="newsletter.loggedIn">
                                    <u-newsletter-toggle-subscription-button
                                        internal-name="ns_with_prefs"
                                        class-name="toggle-btn"
                                        subscribe-class-name="toggle-btn--subscribe"
                                        unsubscribe-class-name="toggle-btn--unsubscribe">
                                    </u-newsletter-toggle-subscription-button>
                                </u-conditional-render>
                            </div>

                            <u-error-message for="ns_with_prefs" class-name="newsletter-card__error"></u-error-message>

                            <u-conditional-render when="newsletter.loggedIn">
                                <u-conditional-render when="newsletter.subscribed" is="ns_with_prefs">
                                    <u-conditional-render when="newsletter.confirmed" is="ns_with_prefs" not>
                                        <div class="doi-banner">
                                            <span class="doi-banner__text">Bitte bestätige deine E-Mail-Adresse</span>
                                            <u-newsletter-resend-doi-button internal-name="ns_with_prefs" class-name="doi-banner__btn">
                                                Erneut senden
                                            </u-newsletter-resend-doi-button>
                                        </div>
                                    </u-conditional-render>
                                </u-conditional-render>
                            </u-conditional-render>

                            <!-- Preferences for Main Newsletter -->
                            <div class="newsletter-card__preferences">
                                <span class="preferences-label">Themen auswählen:</span>
                                <div class="preferences-list">
                                    <label class="preference-chip">
                                        <u-conditional-render when="newsletter.loggedIn" not>
                                            <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="club_news_pref" checked="true" class-name="preference-input"></u-newsletter-preference-checkbox>
                                        </u-conditional-render>
                                        <u-conditional-render when="newsletter.loggedIn">
                                            <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="club_news_pref" class-name="preference-input"></u-newsletter-preference-checkbox>
                                        </u-conditional-render>
                                        <span class="preference-chip__label">Vereinsnews</span>
                                    </label>
                                    <label class="preference-chip">
                                        <u-conditional-render when="newsletter.loggedIn" not>
                                            <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="player_news_pref" checked="true" class-name="preference-input"></u-newsletter-preference-checkbox>
                                        </u-conditional-render>
                                        <u-conditional-render when="newsletter.loggedIn">
                                            <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="player_news_pref" class-name="preference-input"></u-newsletter-preference-checkbox>
                                        </u-conditional-render>
                                        <span class="preference-chip__label">Spieler-News</span>
                                    </label>
                                    <label class="preference-chip">
                                        <u-conditional-render when="newsletter.loggedIn" not>
                                            <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="random_news_pref" checked="true" class-name="preference-input"></u-newsletter-preference-checkbox>
                                        </u-conditional-render>
                                        <u-conditional-render when="newsletter.loggedIn">
                                            <u-newsletter-preference-checkbox internal-name="ns_with_prefs" preference-identifier="random_news_pref" class-name="preference-input"></u-newsletter-preference-checkbox>
                                        </u-conditional-render>
                                        <span class="preference-chip__label">Sonstiges</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Newsletter without Preferences -->
                    <div class="newsletter-grid">
                        <div class="newsletter-card newsletter-card--compact">
                            <div class="newsletter-card__header">
                                <div class="newsletter-card__icon-badge">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                        <polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                </div>
                                <div class="newsletter-card__info">
                                    <h3 class="newsletter-card__title">Allgemeiner Newsletter</h3>
                                    <p class="newsletter-card__description">Kompakte Updates ohne Themenwahl</p>
                                    <u-conditional-render when="newsletter.loggedIn" not>
                                        <span class="newsletter-card__frequency">Nach Bedarf</span>
                                    </u-conditional-render>
                                </div>

                                <u-conditional-render when="newsletter.loggedIn" not>
                                    <u-newsletter-checkbox internal-name="ns_without_prefs" class-name="newsletter-toggle"></u-newsletter-checkbox>
                                </u-conditional-render>

                                <u-conditional-render when="newsletter.loggedIn">
                                    <u-newsletter-toggle-subscription-button
                                        internal-name="ns_without_prefs"
                                        class-name="toggle-btn"
                                        subscribe-class-name="toggle-btn--subscribe"
                                        unsubscribe-class-name="toggle-btn--unsubscribe">
                                    </u-newsletter-toggle-subscription-button>
                                </u-conditional-render>
                            </div>

                            <u-error-message for="ns_without_prefs" class-name="newsletter-card__error"></u-error-message>

                            <u-conditional-render when="newsletter.loggedIn">
                                <u-conditional-render when="newsletter.subscribed" is="ns_without_prefs">
                                    <u-conditional-render when="newsletter.confirmed" is="ns_without_prefs" not>
                                        <div class="doi-banner">
                                            <span class="doi-banner__text">Bitte bestätige deine E-Mail</span>
                                            <u-newsletter-resend-doi-button internal-name="ns_without_prefs" class-name="doi-banner__btn">
                                                Erneut senden
                                            </u-newsletter-resend-doi-button>
                                        </div>
                                    </u-conditional-render>
                                </u-conditional-render>
                            </u-conditional-render>
                        </div>
                    </div>
                </div>
            </section>
        </u-newsletter-root>
    </main>

    <!-- DOI Confirmation Modal (shown after non-logged-in user subscribes) -->
    <dialog id="doi-modal" class="doi-modal">
        <div class="doi-modal__content">
            <div class="doi-modal__icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
            </div>
            <h2 class="doi-modal__title">Vielen Dank für deine Anmeldung!</h2>
            <p class="doi-modal__text">
                Wir haben dir eine Bestätigungs-E-Mail gesendet.<br>
                <strong>Bitte klicke auf den Link in der E-Mail</strong>, um deine Anmeldung abzuschließen.
            </p>
            <div class="doi-modal__hint">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>Keine E-Mail erhalten? Prüfe deinen Spam-Ordner.</span>
            </div>
            <div class="doi-modal__actions">
                <button type="button" class="doi-modal__btn" data-close-doi-modal>Verstanden</button>
            </div>
        </div>
    </dialog>

    <script is:inline>
        document.addEventListener('DOMContentLoaded', () => {
            const doiModal = document.getElementById('doi-modal');
            let wasLoggedIn = false;

            // Check initial login state
            const checkInitialState = () => {
                const newsletterRoot = document.querySelector('u-newsletter-root');
                if (newsletterRoot) {
                    // Check if logged in state is visible
                    const loggedInElement = document.querySelector('.action-bar-card--success');
                    wasLoggedIn = loggedInElement && loggedInElement.offsetParent !== null;
                }
            };

            // Observe for login state changes
            const observeLoginState = () => {
                const observer = new MutationObserver(() => {
                    const loggedInElement = document.querySelector('.action-bar-card--success');
                    const isLoggedIn = loggedInElement && loggedInElement.offsetParent !== null;

                    // If user just logged in (state changed from not logged in to logged in)
                    if (!wasLoggedIn && isLoggedIn) {
                        // Show DOI modal
                        if (doiModal) {
                            doiModal.showModal();
                        }
                    }
                    wasLoggedIn = isLoggedIn;
                });

                const newsletterRoot = document.querySelector('u-newsletter-root');
                if (newsletterRoot) {
                    observer.observe(newsletterRoot, {
                        childList: true,
                        subtree: true,
                        attributes: true
                    });
                }
            };

            // Close DOI modal
            document.querySelectorAll('[data-close-doi-modal]').forEach(button => {
                button.addEventListener('click', () => {
                    if (doiModal) {
                        doiModal.close();
                    }
                });
            });

            // Close on backdrop click
            if (doiModal) {
                doiModal.addEventListener('click', (e) => {
                    if (e.target === doiModal) {
                        doiModal.close();
                    }
                });
            }

            // Initialize
            setTimeout(() => {
                checkInitialState();
                observeLoginState();
            }, 100);
        });
    </script>
</Layout>
