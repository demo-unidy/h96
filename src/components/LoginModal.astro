---
// Login Modal Component - Handles authentication flow
---

<!-- Login Modal Overlay -->
<div class="login-modal-overlay" id="loginModalOverlay">
    <u-signin-root>
        <u-config
            base-url="https://hannover96.staging.unidy.de"
            api-key="b9671a31543ed2db7679511882ece8fcbd020f8ee996a3274026302a1834c82e"
            locale="de"
        ></u-config>

        <div class="login-modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
            <button type="button" class="login-modal__close" onclick="closeLoginModal()" aria-label="Schließen">&times;</button>

            <div class="login-modal__header">
                <div class="login-modal__logo">
                    <img src="/assets/images/h96-logo.svg" alt="Hannover 96" height="60">
                </div>
                <h2 id="loginModalTitle" class="login-modal__title">Anmelden bei Hannover 96</h2>
            </div>

            <div class="login-modal__body">
                <!-- Step 1: Email Entry -->
                <u-signin-step step="1">
                    <form class="login-form" id="emailForm">
                        <div class="login-form__field">
                            <label class="login-form__label" for="loginEmail">E-Mail-Adresse</label>
                            <u-email-field class-name="login-input" name="email" id="loginEmail" placeholder="deine@email.de" required></u-email-field>
                        </div>
                        <u-error-message name="email" class-name="form-error"></u-error-message>
                        <u-submit-button class-name="login-submit">Weiter</u-submit-button>
                    </form>

                    <div class="login-divider">
                        <span class="login-divider__line"></span>
                        <span class="login-divider__text">oder</span>
                        <span class="login-divider__line"></span>
                    </div>

                    <u-social-login-button provider="google" class-name="social-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        Mit Google anmelden
                    </u-social-login-button>
                </u-signin-step>

                <!-- Step 2: Registration (New User) -->
                <u-signin-step step="2">
                    <h3 class="login-form__title">Registrierung</h3>
                    <p class="login-info-text">Erstelle dein Hannover 96 Konto</p>

                    <form class="login-form" id="registrationForm">
                        <div id="registrationError" class="form-error" style="display: none;"></div>

                        <div class="login-form__field">
                            <label class="login-form__label">E-Mail</label>
                            <u-email-field class-name="login-input" name="email" readonly></u-email-field>
                        </div>

                        <div class="login-form__field">
                            <label class="login-form__label">Anrede</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="salutation" value="male">
                                    <span>Herr</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="salutation" value="female">
                                    <span>Frau</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="salutation" value="diverse">
                                    <span>Divers</span>
                                </label>
                            </div>
                        </div>

                        <div class="name-row">
                            <div class="login-form__field">
                                <label class="login-form__label" for="regFirstName">Vorname</label>
                                <input type="text" class="login-input" name="firstName" id="regFirstName" required>
                            </div>
                            <div class="login-form__field">
                                <label class="login-form__label" for="regLastName">Nachname</label>
                                <input type="text" class="login-input" name="lastName" id="regLastName" required>
                            </div>
                        </div>

                        <div class="login-form__field">
                            <label class="login-form__label" for="regPassword">Passwort</label>
                            <input type="password" class="login-input" name="password" id="regPassword" required minlength="8">
                            <span class="password-requirements">Mind. 8 Zeichen, 1 Großbuchstabe, 1 Zahl</span>
                        </div>

                        <div class="login-form__field">
                            <label class="login-form__label" for="regPasswordConfirm">Passwort bestätigen</label>
                            <input type="password" class="login-input" name="passwordConfirm" id="regPasswordConfirm" required>
                        </div>

                        <button type="submit" class="login-submit" id="registrationSubmitBtn">Registrieren</button>
                    </form>
                </u-signin-step>

                <!-- Step 3: Verification (Existing User) -->
                <u-signin-step step="3">
                    <h3 class="login-form__title">Willkommen zurück!</h3>
                    <p class="login-info-text">Bitte gib dein Passwort ein</p>

                    <form class="login-form">
                        <div class="login-form__field">
                            <label class="login-form__label">E-Mail</label>
                            <u-email-field class-name="login-input" name="email" readonly></u-email-field>
                        </div>

                        <div class="login-form__field">
                            <label class="login-form__label" for="loginPassword">Passwort</label>
                            <u-password-field class-name="login-input" name="password" id="loginPassword" placeholder="Dein Passwort"></u-password-field>
                        </div>

                        <u-error-message name="password" class-name="form-error"></u-error-message>
                        <u-submit-button class-name="login-submit">Anmelden</u-submit-button>

                        <u-reset-password-button class-name="forgot-password-link">Passwort vergessen?</u-reset-password-button>

                        <div class="login-divider">
                            <span class="login-divider__line"></span>
                            <span class="login-divider__text">oder</span>
                            <span class="login-divider__line"></span>
                        </div>

                        <u-send-magic-code-button class-name="magic-link-btn">
                            Anmelden mit Magic Link
                        </u-send-magic-code-button>
                    </form>
                </u-signin-step>

                <!-- Step 4: Magic Code Verification -->
                <u-signin-step step="4">
                    <h3 class="login-form__title">Code eingeben</h3>
                    <p class="login-magic-code-hint">Wir haben dir einen Code per E-Mail gesendet</p>

                    <form class="login-form">
                        <div class="login-form__field">
                            <label class="login-form__label" for="magicCode">Verifizierungscode</label>
                            <u-magic-code-field class-name="login-input" name="magic-code" id="magicCode" placeholder="6-stelliger Code"></u-magic-code-field>
                        </div>

                        <u-error-message name="magic-code" class-name="form-error"></u-error-message>
                        <u-submit-button class-name="login-submit">Bestätigen</u-submit-button>
                    </form>
                </u-signin-step>

                <!-- Step 5: Missing Fields -->
                <u-signin-step step="5">
                    <h3 class="login-form__title">Fast geschafft!</h3>
                    <p class="login-info-text">Bitte vervollständige dein Profil</p>

                    <form class="login-form">
                        <u-conditional-render if="profile.salutation == null">
                            <u-missing-field name="salutation"></u-missing-field>
                        </u-conditional-render>
                        <u-conditional-render if="profile.firstName == null">
                            <u-missing-field name="firstName"></u-missing-field>
                        </u-conditional-render>
                        <u-conditional-render if="profile.lastName == null">
                            <u-missing-field name="lastName"></u-missing-field>
                        </u-conditional-render>

                        <u-missing-fields-submit-button class-name="login-submit">Speichern</u-missing-fields-submit-button>
                    </form>
                </u-signin-step>

                <!-- Step 6: Password Reset -->
                <u-signin-step step="6">
                    <h3 class="login-form__title">Passwort zurücksetzen</h3>
                    <p class="login-info-text">Gib den Code aus deiner E-Mail ein und wähle ein neues Passwort</p>

                    <form class="login-form">
                        <div class="login-form__field">
                            <label class="login-form__label" for="resetCode">Verifizierungscode</label>
                            <u-magic-code-field class-name="login-input" name="magic-code" id="resetCode" placeholder="6-stelliger Code"></u-magic-code-field>
                        </div>

                        <div class="login-form__field">
                            <label class="login-form__label" for="newPassword">Neues Passwort</label>
                            <u-password-field class-name="login-input" name="password" id="newPassword" placeholder="Neues Passwort"></u-password-field>
                            <span class="password-requirements">Mind. 8 Zeichen, 1 Großbuchstabe, 1 Zahl</span>
                        </div>

                        <u-error-message name="magic-code" class-name="form-error"></u-error-message>
                        <u-error-message name="password" class-name="form-error"></u-error-message>
                        <u-submit-button class-name="login-submit">Passwort ändern</u-submit-button>
                    </form>
                </u-signin-step>

                <!-- Success Step -->
                <u-signin-step step="7">
                    <div class="login-success" id="loginSuccess">
                        <div class="login-success__icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <h3 class="login-success__title">Anmeldung erfolgreich!</h3>
                        <p class="login-success__text">Du wirst automatisch weitergeleitet...</p>
                    </div>
                </u-signin-step>
            </div>
        </div>
    </u-signin-root>
</div>

<script is:inline>
    const loginModalOverlay = document.getElementById('loginModalOverlay');
    const loginModal = document.getElementById('loginModal');

    function openLoginModal() {
        loginModalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        // Focus first input
        setTimeout(() => {
            const firstInput = loginModal.querySelector('input:not([readonly])');
            if (firstInput) firstInput.focus();
        }, 100);
    }

    function closeLoginModal() {
        loginModalOverlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close on overlay click
    loginModalOverlay?.addEventListener('click', (e) => {
        if (e.target === loginModalOverlay) {
            closeLoginModal();
        }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && loginModalOverlay?.classList.contains('active')) {
            closeLoginModal();
        }
    });

    // Make functions globally available
    window.openLoginModal = openLoginModal;
    window.closeLoginModal = closeLoginModal;

    // Registration form handler
    const registrationForm = document.getElementById('registrationForm');
    const registrationError = document.getElementById('registrationError');

    if (registrationForm) {
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            registrationError.style.display = 'none';

            const formData = new FormData(registrationForm);
            const emailField = registrationForm.querySelector('u-email-field');
            const email = emailField?.value || emailField?.querySelector('input')?.value;

            const password = formData.get('password');
            const passwordConfirm = formData.get('passwordConfirm');

            // Validate passwords match
            if (password !== passwordConfirm) {
                registrationError.textContent = 'Die Passwörter stimmen nicht überein';
                registrationError.style.display = 'block';
                registrationError.classList.add('visible');
                return;
            }

            // Validate password strength
            const passwordRegex = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(password)) {
                registrationError.textContent = 'Das Passwort muss mindestens 8 Zeichen lang sein und mindestens einen Großbuchstaben und eine Zahl enthalten';
                registrationError.style.display = 'block';
                registrationError.classList.add('visible');
                return;
            }

            const submitBtn = document.getElementById('registrationSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');

            try {
                // Create registration via API
                const response = await fetch('https://hannover96.staging.unidy.de/api/sdk/v1/registration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': 'b9671a31543ed2db7679511882ece8fcbd020f8ee996a3274026302a1834c82e'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        salutation: formData.get('salutation'),
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName')
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Registrierung fehlgeschlagen');
                }

                // Finalize registration
                const finalizeResponse = await fetch('https://hannover96.staging.unidy.de/api/sdk/v1/registration/finalize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': 'b9671a31543ed2db7679511882ece8fcbd020f8ee996a3274026302a1834c82e'
                    },
                    body: JSON.stringify({ email: email })
                });

                if (finalizeResponse.ok) {
                    // Show success state
                    registrationError.textContent = 'Registrierung erfolgreich! Du wirst angemeldet...';
                    registrationError.classList.add('visible', 'success');
                    registrationError.style.display = 'block';

                    // Close modal and reload after delay
                    setTimeout(() => {
                        closeLoginModal();
                        window.location.reload();
                    }, 3000);
                }
            } catch (error) {
                registrationError.textContent = error.message || 'Ein Fehler ist aufgetreten. Bitte versuche es erneut.';
                registrationError.style.display = 'block';
                registrationError.classList.add('visible');
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        });
    }
</script>
